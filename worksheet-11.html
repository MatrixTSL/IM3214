<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matrix TSL - Closed-Loop Control</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="assets/icons/matrix-icon.ico">
  <link rel="manifest" href="manifest.json">
  <script src="worksheet-core.js"></script>
  <script src="worksheet-tracking.js"></script>
  <script defer src="shared-navigation.js"></script>
  <script defer src="pwa-install.js"></script>

</head>
<body>
  <!-- Main Content -->
  <div class="worksheet-box">
    <!-- Integrated Worksheet Header -->
    <div class="worksheet-header">
      <div class="worksheet-header-content">
        <div class="worksheet-header-left">
          <button class="worksheet-nav-btn worksheet-back-btn" onclick="window.location.href='worksheet-10.html'">
            <i class="fas fa-arrow-left"></i>
            <span>Previous Worksheet</span>
          </button>
        </div>
        <div class="worksheet-header-center">
          <h1 class="worksheet-title">Worksheet 11 - Closed-Loop Control</h1>
        </div>
        <div class="worksheet-header-right">
          <button class="worksheet-nav-btn worksheet-next-btn" onclick="window.location.href='CP6211-worksheets.html'">
            <span>Back to Worksheets</span>
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="worksheet-section introduction-section">
      <h2 class="section-header"><i class="fas fa-info-circle"></i> 1. Introduction</h2>
      <div class="worksheet-content">
        <div class="introduction-content-wrapper">
          <div class="introduction-text">
            <p>A closed-loop control system uses feedback to monitor the actual output and adjust control signals accordingly. Unlike open-loop systems, closed-loop systems can detect when something goes wrong and automatically correct for faults or changes in the process.</p>
          </div>
          <div class="introduction-image">
            <div class="system-diagram">
              <img src="assets/maintenance/ws11.png" alt="Closed-Loop Control System">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Over To You Section -->
    <div class="worksheet-section over-to-you-section">
      <h2 class="section-header"><i class="fas fa-hands-helping"></i> 2. Over To You</h2>
      <div class="worksheet-content">
        <p><strong>Follow these steps to explore closed-loop control systems:</strong></p>

        <div class="steps-container">
          <div class="step-card" data-step="1">
            <div class="step-number">1</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Build the Closed-Loop System</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="step-checkmark"></span>
                </label>
              </div>
              <div class="step-description">
                <p>Build the system shown in the diagram. This includes a feedback sensor to monitor the actual output and compare it to the desired setpoint.</p>
              </div>
            </div>
          </div>

          <div class="step-card" data-step="2">
            <div class="step-number">2</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Load Program 11</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="step-checkmark"></span>
                </label>
              </div>
              <div class="step-description">
                <p>Load the closed-loop control program. This program compares the feedback signal with the setpoint and adjusts the output to minimize the error.</p>
              </div>
            </div>
          </div>

          <div class="step-card" data-step="3">
            <div class="step-number">3</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Test Feedback Response</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="step-checkmark"></span>
                </label>
              </div>
              <div class="step-description">
                <p>Set a target value and observe how the system automatically adjusts the output to maintain the setpoint, even when disturbances occur. Notice how feedback enables automatic correction.</p>
              </div>
            </div>
          </div>

          <div class="step-card" data-step="4">
            <div class="step-number">4</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Simulate a Fault</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="step-checkmark"></span>
                </label>
              </div>
              <div class="step-description">
                <p>Introduce a disturbance to the system and watch how the closed-loop control automatically compensates, unlike open-loop systems that cannot detect or correct for faults.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- So What Section -->
    <div class="worksheet-section so-what-section">
      <h2 class="section-header"><i class="fas fa-lightbulb"></i> 3. So What?</h2>
      <div class="worksheet-content">
        <div class="explanation-card">
          <div class="card-header">
            <i class="fas fa-cogs"></i>
            <h3>Closed-Loop vs Open-Loop</h3>
          </div>
          <div class="card-content">
            <p>Closed-loop systems use feedback to monitor actual performance and automatically adjust outputs. This makes them more accurate and reliable than open-loop systems, but also more complex. They can detect and compensate for faults automatically.</p>
          </div>
        </div>

        <div class="explanation-card">
          <div class="card-header">
            <i class="fas fa-bolt"></i>
            <h3>Feedback Control</h3>
          </div>
          <div class="card-content">
            <p>The feedback sensor continuously monitors the actual output and compares it to the desired setpoint. The control system calculates the error and adjusts the output to minimize this difference, creating a self-correcting system.</p>
          </div>
        </div>

        <div class="explanation-card">
          <div class="card-header">
            <i class="fas fa-list-ol"></i>
            <h3>Industrial Applications</h3>
          </div>
          <div class="card-content">
            <p>Closed-loop systems are essential in temperature control, pressure regulation, flow control, and precise positioning systems where accuracy and automatic fault correction are critical for safe operation.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Key Takeaways Section -->
    <div class="worksheet-section key-takeaways-section">
      <h2 class="section-header"><i class="fas fa-list-check"></i> Key Takeaways</h2>
      <ul>
        <li>Closed-loop systems use feedback to monitor actual output and adjust control automatically.</li>
        <li>Feedback enables automatic error correction and fault detection.</li>
        <li>Closed-loop systems are more accurate but more complex than open-loop systems.</li>
        <li>Essential for temperature, pressure, flow, and position control applications.</li>
        <li>Better diagnostics through comparison of setpoint, feedback, and output values.</li>
      </ul>
    </div>

    <div class="worksheet-section questions-section">
      <h2 class="section-header"><i class="fas fa-question-circle"></i> Questions & Answers</h2>
      <div class="questions-content">
        <div class="question-item" data-question="1">
          <h4>Question 1: What is the main advantage of closed-loop control systems over open-loop systems?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-1" value="A" class="option-radio">
              <span class="option-text">A) They are simpler to program</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-1" value="B" class="option-radio">
              <span class="option-text">B) They use feedback to automatically correct for errors and disturbances</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-1" value="C" class="option-radio">
              <span class="option-text">C) They are cheaper to install</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-1" value="D" class="option-radio">
              <span class="option-text">D) They use less power</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(1)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> B) They use feedback to automatically correct for errors and disturbances.
          </div>
        </div>
        
        <div class="question-item" data-question="2">
          <h4>Question 2: What component is essential for a closed-loop control system to function?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-2" value="A" class="option-radio">
              <span class="option-text">A) A feedback sensor to monitor the actual output</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-2" value="B" class="option-radio">
              <span class="option-text">B) A larger motor</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-2" value="C" class="option-radio">
              <span class="option-text">C) More expensive components</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-2" value="D" class="option-radio">
              <span class="option-text">D) Better documentation</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(2)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> A) A feedback sensor to monitor the actual output.
          </div>
        </div>
        
        <div class="question-item" data-question="3">
          <h4>Question 3: In which applications are closed-loop control systems most essential?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-3" value="A" class="option-radio">
              <span class="option-text">A) Temperature, pressure, and flow control where accuracy is critical</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-3" value="B" class="option-radio">
              <span class="option-text">B) Simple on/off lighting systems</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-3" value="C" class="option-radio">
              <span class="option-text">C) Basic equipment monitoring</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-3" value="D" class="option-radio">
              <span class="option-text">D) Emergency stop systems</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(3)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> A) Temperature, pressure, and flow control where accuracy is critical.
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  
  <script>
    // Initialize everything when the DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      loadSavedAnswers();
    });
    
        function submitAnswer(questionNumber) {
          const answerInput = document.querySelector(`[data-question="${questionNumber}"]`);
          if (!answerInput) return;
          
          const selectedOption = document.querySelector(`input[name="question-${questionNumber}"]:checked`);
          if (!selectedOption) {
            alert('Please select an answer before submitting.');
            return;
          }
          
          const answer = selectedOption.value;
          
          // Save with enhanced tracking
          worksheetTracker.saveAnswer(11, questionNumber, answer, 'maintenance');
          
          // Define correct answers for worksheet 11
          const correctAnswers = {
            1: 'B',
            2: 'A',
            3: 'A'
          };
          
          // Check if the answer is correct
          const isCorrect = correctAnswers[questionNumber] === answer;
          
          // Show the correct answer
          const correctAnswerDiv = answerInput.querySelector('.correct-answer');
          if (correctAnswerDiv) {
            correctAnswerDiv.style.display = 'block';
          }
          
          // Disable all options for this question
          const allOptions = answerInput.querySelectorAll('input[type="radio"]');
          allOptions.forEach(option => option.disabled = true);
          
          // Hide the submit button
          const submitBtn = answerInput.querySelector('.submit-question-btn');
          if (submitBtn) {
            submitBtn.style.display = 'none';
          }
          
          // Update tracking
          worksheetTracker.setQuestionCompleted(11, questionNumber, isCorrect);
          
          console.log(`Question ${questionNumber}: ${isCorrect ? 'Correct' : 'Incorrect'}`);
        }
        
        function loadSavedAnswers() {
          // This function is now handled by the tracking system
        }
  </script>
  
<script>
// Enhanced step tracking functionality
let isProcessing = false;

function initializeStepTracking() {
  console.log('Initializing step tracking...');
  
  // Wait for DOM to be fully ready
  setTimeout(() => {
    const stepCards = document.querySelectorAll('.step-card');
    console.log('Found step cards:', stepCards.length);
    
    stepCards.forEach((card, index) => {
      const stepNumber = index + 1;
      const checkbox = card.querySelector('.step-complete-checkbox');
      
      if (!checkbox) {
        console.log('No checkbox found for step', stepNumber);
        return;
      }
      
      console.log('Setting up step', stepNumber);
      
      // Load saved state
      const savedState = localStorage.getItem(`step-${stepNumber}`);
      if (savedState === 'true') {
        checkbox.checked = true;
        card.classList.add('step-completed');
        card.style.background = '#2a2a2a';
        card.style.opacity = '0.7';
        card.style.cursor = 'default';
      }
      
      // Enhanced checkbox change handler
      function handleCheckboxChange(checkbox, card, stepNumber) {
        console.log('Handling checkbox change for step', stepNumber, checkbox.checked);
        
        if (checkbox.checked) {
          card.classList.add('step-completed');
          card.style.background = '#2a2a2a';
          card.style.opacity = '0.7';
          card.style.cursor = 'default';
          localStorage.setItem(`step-${stepNumber}`, 'true');
        } else {
          card.classList.remove('step-completed');
          card.style.background = '';
          card.style.opacity = '';
          card.style.cursor = 'pointer';
          localStorage.setItem(`step-${stepNumber}`, 'false');
        }
      }
      
      // Add change handler to checkbox
      checkbox.addEventListener('change', function() {
        if (!isProcessing) {
          handleCheckboxChange(checkbox, card, stepNumber);
        }
      });
      
      // Add click handler to the entire card
      card.addEventListener('click', function(e) {
        console.log('Card clicked:', stepNumber);
        
        // Prevent double execution
        if (isProcessing) {
          console.log('Already processing, ignoring click');
          return;
        }
        
        // Don't toggle if clicking directly on the checkbox or its label
        if (e.target === checkbox || 
            e.target.closest('.step-checkbox') || 
            e.target.closest('label') ||
            e.target.tagName === 'INPUT' ||
            e.target.tagName === 'LABEL') {
          console.log('Clicking on checkbox or label, not toggling card');
          return;
        }
        
        // Prevent the default checkbox behavior and stop propagation
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        // Set processing flag
        isProcessing = true;
        
        // Toggle the checkbox directly without triggering events
        checkbox.checked = !checkbox.checked;
        
        // Handle the change manually
        handleCheckboxChange(checkbox, card, stepNumber);
        
        // Reset processing flag after a small delay
        setTimeout(() => {
          isProcessing = false;
        }, 100);
      });
      
      // Also make the checkbox itself clickable
      checkbox.addEventListener('click', function(e) {
        e.stopPropagation();
        e.stopImmediatePropagation();
      });
    });
  }, 100);
}

// Initialize when page loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeStepTracking);
} else {
  initializeStepTracking();
}

// Also try again after a short delay to ensure everything is ready
setTimeout(initializeStepTracking, 500);

</script>
</body>
</html>
